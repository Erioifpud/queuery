{"version":3,"file":"index.js","sources":["../../src/index.js"],"sourcesContent":["export default class Queuery {\n  constructor (options) {\n    const { limit = 3, retries = 3, verbose } = options || {}\n    this.queue = []\n    this.running = 0\n    this.limit = limit\n    this.retries = retries\n    this.results = []\n    this.verbose = verbose\n  }\n\n  task (promiseWrapper, ...args) {\n    this.taskWithName(args, promiseWrapper, ...args)\n  }\n\n  taskWithName (name, promiseWrapper, ...args) {\n    this.queue.push({\n      name,\n      promiseWrapper,\n      args: args.length ? args : [],\n      retries: 0\n    })\n  }\n\n  remove (name) {\n    const index = this.queue.findIndex(item => item.name === name)\n    if (index === -1) {\n      return\n    }\n    this.queue.splice(index, 1)\n    this.verbose && console.log(name, 'removed')\n  }\n\n  __checkNext (done) {\n    if (!this.queue.length) {\n      done()\n      return\n    }\n    const item = this.queue.shift()\n    const { name, promiseWrapper, args, retries } = item\n    if (!retries) {\n      this.running++\n    }\n    const promise = promiseWrapper(...args)\n    promise.then(data => {\n      this.running--\n      this.verbose && console.log(name, 'finished')\n      this.results.push({\n        name,\n        payload: data\n      })\n      this.__checkNext(done)\n      return data\n    }).catch((err) => {\n      if (retries < this.retries) {\n        this.queue.push({\n          ...item,\n          retries: retries + 1\n        })\n        this.verbose && console.log(name, 'is retrying: ', retries)\n        this.__checkNext(done)\n      } else {\n        this.running--\n        this.verbose && console.error(name, 'failed')\n        this.results.push({\n          name,\n          payload: err\n        })\n        this.__checkNext(done)\n        return err\n      }\n    })\n  }\n\n  start (onFinish) {\n    const length = this.queue.length < this.limit ? this.queue.length : this.limit\n    if (!length) {\n      onFinish(this.results)\n      return\n    }\n    const getDone = (resolve) => {\n      let count = 0\n      return () => {\n        count++\n        if (count >= length) {\n          resolve()\n        }\n      }\n    }\n    new Promise((resolve) => {\n      const done = getDone(resolve)\n      for (let i = 0; i < length; i++) {\n        this.__checkNext(done)\n      }\n    }).then(() => {\n      onFinish(this.results)\n    })\n  }\n}\n"],"names":["Queuery","options","limit","retries","verbose","queue","running","results","promiseWrapper","args","taskWithName","name","push","length","index","findIndex","item","splice","console","log","done","shift","promise","then","data","payload","__checkNext","err","error","onFinish","getDone","resolve","count","Promise","i"],"mappings":"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"}