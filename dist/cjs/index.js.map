{"version":3,"file":"index.js","sources":["../../src/index.js"],"sourcesContent":["export default class Queuery {\n  constructor (options) {\n    const { limit = 3, retries = 3, verbose } = options || {}\n    this.queue = []\n    this.running = 0\n    this.limit = limit\n    this.retries = retries\n    this.results = []\n    this.verbose = verbose\n  }\n\n  task (promiseWrapper, ...args) {\n    this.taskWithName(args, promiseWrapper, ...args)\n  }\n\n  taskWithName (name, promiseWrapper, ...args) {\n    this.queue.push({\n      name,\n      promiseWrapper,\n      args: args.length ? args : [],\n      retries: 0\n    })\n  }\n\n  remove (name) {\n    const index = this.queue.findIndex(item => item.name === name)\n    if (index === -1) {\n      return\n    }\n    this.queue.splice(index, 1)\n    this.verbose && console.log(name, 'removed')\n  }\n\n  __checkNext (done) {\n    if (!this.queue.length) {\n      done()\n      return\n    }\n    const item = this.queue.shift()\n    const { name, promiseWrapper, args, retries } = item\n    if (!retries) {\n      this.running++\n    }\n    const promise = promiseWrapper(...args)\n    promise.then(data => {\n      this.running--\n      this.verbose && console.log(name, 'finished')\n      this.results.push({\n        name,\n        payload: data\n      })\n      this.__checkNext(done)\n      return data\n    }).catch((err) => {\n      if (retries < this.retries) {\n        this.queue.push({\n          ...item,\n          retries: retries + 1\n        })\n        this.verbose && console.log(name, 'is retrying: ', retries)\n        this.__checkNext(done)\n      } else {\n        this.running--\n        this.verbose && console.error(name, 'failed')\n        this.results.push({\n          name,\n          payload: err\n        })\n        this.__checkNext(done)\n        return err\n      }\n    })\n  }\n\n  start (onFinish) {\n    const length = this.queue.length < this.limit ? this.queue.length : this.limit\n    if (!length) {\n      onFinish(this.results)\n      return\n    }\n    const getDone = (resolve) => {\n      let count = 0\n      return () => {\n        count++\n        if (count >= length) {\n          resolve()\n        }\n      }\n    }\n    new Promise((resolve) => {\n      const done = getDone(resolve)\n      for (let i = 0; i < length; i++) {\n        this.__checkNext(done)\n      }\n    }).then(() => {\n      onFinish(this.results)\n    })\n  }\n}\n"],"names":["Queuery","options","limit","retries","verbose","queue","running","results","promiseWrapper","args","taskWithName","name","push","length","index","findIndex","item","splice","console","log","done","shift","promise","then","data","payload","__checkNext","err","error","onFinish","getDone","resolve","count","Promise","i"],"mappings":"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"}